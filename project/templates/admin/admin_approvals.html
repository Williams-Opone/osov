<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Approvals & Applications - OSOV Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans antialiased overflow-hidden">

    <div class="flex h-screen">
        
        {% include 'admin/_sidebar.html' %}

        <main class="flex-1 ml-64 flex flex-col h-screen overflow-hidden">
            
            <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shrink-0">
                <h1 class="text-2xl font-bold text-gray-900">Application Management</h1>
                
                <div class="flex items-center gap-3">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mr-2">Export Data:</span>
                    
                    <a href="{{ url_for('admin.export_partners') }}" class="flex items-center gap-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded-lg text-sm font-medium transition shadow-sm" title="Download CSV">
                        <i class="fa-solid fa-file-csv text-green-600"></i> Partners
                    </a>
                    
                    <a href="{{ url_for('admin.export_volunteers') }}" class="flex items-center gap-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded-lg text-sm font-medium transition shadow-sm" title="Download CSV">
                        <i class="fa-solid fa-file-csv text-purple-600"></i> Volunteers
                    </a>
                    
                    <a href="{{ url_for('admin.export_mentorships') }}" class="flex items-center gap-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded-lg text-sm font-medium transition shadow-sm" title="Download CSV">
                        <i class="fa-solid fa-file-csv text-blue-600"></i> Mentors
                    </a>
                </div>
            </header>

            <div class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-8">
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="text-xs font-bold text-gray-500 uppercase mb-1">Partners Applied</div>
                        <div class="text-2xl font-bold text-gray-900">{{ stats.partners_applied }}</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 border-l-4 border-green-500">
                        <div class="text-xs font-bold text-green-600 uppercase mb-1">Partners Approved</div>
                        <div class="text-2xl font-bold text-gray-900">{{ stats.partners_approved }}</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 border-l-4 border-red-500">
                        <div class="text-xs font-bold text-red-600 uppercase mb-1">Partners Rejected</div>
                        <div class="text-2xl font-bold text-gray-900">{{ stats.partners_rejected }}</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 border-l-4 border-purple-500">
                        <div class="text-xs font-bold text-purple-600 uppercase mb-1">Volunteers (Total / Approved)</div>
                        <div class="flex items-end gap-2">
                            <div class="text-2xl font-bold text-gray-900">{{ stats.volunteers_applied }}</div>
                            <div class="text-sm font-medium text-gray-500 mb-1">/ {{ stats.volunteers_approved }} Active</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-8 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 bg-purple-50 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-purple-900">Pending Volunteer Applications</h3>
                        <span class="text-xs bg-white text-purple-800 px-2 py-1 rounded-full font-bold border border-purple-100">Review Needed</span>
                    </div>
                
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-left text-sm">
                            <thead class="bg-gray-50 text-gray-500 uppercase font-bold border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-3">Applicant</th>
                                    <th class="px-6 py-3">Location</th>
                                    <th class="px-6 py-3">Motivation</th>
                                    <th class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for vol in volunteers_pagination.items %}
                                <tr class="hover:bg-gray-50 transition">
                                    <td class="px-6 py-4">
                                        <div class="font-bold text-gray-900">{{ vol.user.first_name }} {{ vol.user.last_name }}</div>
                                        <a href="mailto:{{ vol.user.email }}" class="text-xs text-blue-600 hover:underline">{{ vol.user.email }}</a>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="text-gray-900">{{ vol.country }}</div>
                                        {% if vol.is_under_18 %}
                                            <span class="text-[10px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded font-bold">Under 18</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 text-gray-600 max-w-xs truncate" title="{{ vol.motivation }}">
                                        {{ vol.motivation }}
                                    </td>
                                    <td class="px-6 py-4 text-right flex justify-end gap-2">
                                        <a href="{{ url_for('admin.process_volunteer', id=vol.id, action='approve') }}" 
                                           class="bg-green-100 text-green-700 hover:bg-green-200 px-3 py-1 rounded text-xs font-bold transition">
                                            <i class="fa-solid fa-check"></i> Accept
                                        </a>
                                        <a href="{{ url_for('admin.process_volunteer', id=vol.id, action='reject') }}" 
                                           class="bg-red-100 text-red-700 hover:bg-red-200 px-3 py-1 rounded text-xs font-bold transition"
                                           onclick="return confirm('Reject this volunteer?')">
                                            <i class="fa-solid fa-xmark"></i> Reject
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="px-6 py-8 text-center text-gray-400">
                                        <i class="fa-solid fa-hands-helping text-2xl mb-2 opacity-50"></i>
                                        <p>No pending volunteer applications.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if volunteers_pagination.pages > 1 %}
                    <div class="px-6 py-3 border-t border-gray-200 bg-gray-50 flex justify-end gap-2">
                        {% if volunteers_pagination.has_prev %}
                            <a href="{{ url_for('admin.approvals', v_page=volunteers_pagination.prev_num) }}" class="px-3 py-1 border rounded text-xs hover:bg-gray-200">Previous</a>
                        {% endif %}
                        <span class="px-3 py-1 text-xs text-gray-500 font-bold">Page {{ volunteers_pagination.page }} of {{ volunteers_pagination.pages }}</span>
                        {% if volunteers_pagination.has_next %}
                            <a href="{{ url_for('admin.approvals', v_page=volunteers_pagination.next_num) }}" class="px-3 py-1 border rounded text-xs hover:bg-gray-200">Next</a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-8 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-900">Pending Partnership Applications</h3>
                        <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-bold">Action Required</span>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full text-left text-sm">
                            <thead class="bg-gray-100 text-gray-500 uppercase font-bold border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-3">Organization</th>
                                    <th class="px-6 py-3">Representative</th>
                                    <th class="px-6 py-3">Type</th>
                                    <th class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for app in partners_pagination.items %}
                                <tr class="hover:bg-gray-50 transition">
                                    <td class="px-6 py-4">
                                        <div class="font-bold text-gray-900">{{ app.org_name }}</div>
                                        <div class="text-xs text-gray-500">{{ app.website or 'No website' }}</div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="text-gray-900">{{ app.user.first_name }} {{ app.user.last_name }}</div>
                                        <a href="mailto:{{ app.user.email }}" class="text-xs text-blue-600 hover:underline">{{ app.user.email }}</a>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span class="inline-block bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded border border-blue-100">
                                            {{ app.partnership_type }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-right flex justify-end gap-2">
                                        <a href="{{ url_for('admin.process_partner', id=app.id, action='approve') }}" 
                                           class="bg-green-100 text-green-700 hover:bg-green-200 px-3 py-1 rounded text-xs font-bold transition"
                                           onclick="return confirm('Are you sure you want to APPROVE this partner? An email will be sent.')">
                                            <i class="fa-solid fa-check"></i> Approve
                                        </a>
                                        <a href="{{ url_for('admin.process_partner', id=app.id, action='reject') }}" 
                                           class="bg-red-100 text-red-700 hover:bg-red-200 px-3 py-1 rounded text-xs font-bold transition"
                                           onclick="return confirm('Are you sure you want to REJECT this application?')">
                                            <i class="fa-solid fa-xmark"></i> Reject
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="px-6 py-8 text-center text-gray-400">
                                        <i class="fa-solid fa-check-circle text-2xl mb-2 opacity-50"></i>
                                        <p>No pending partnership applications.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if partners_pagination.pages > 1 %}
                    <div class="px-6 py-3 border-t border-gray-200 bg-gray-50 flex justify-end gap-2">
                        {% if partners_pagination.has_prev %}
                            <a href="{{ url_for('admin.approvals', page=partners_pagination.prev_num) }}" class="px-3 py-1 border rounded text-xs hover:bg-gray-200">Previous</a>
                        {% endif %}
                        <span class="px-3 py-1 text-xs text-gray-500 font-bold">Page {{ partners_pagination.page }} of {{ partners_pagination.pages }}</span>
                        {% if partners_pagination.has_next %}
                            <a href="{{ url_for('admin.approvals', page=partners_pagination.next_num) }}" class="px-3 py-1 border rounded text-xs hover:bg-gray-200">Next</a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-8 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 bg-green-50 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-green-900">Active Partnership Management</h3>
                        <span class="text-xs bg-white text-green-800 px-2 py-1 rounded-full font-bold border border-green-200">Live Partners</span>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-left text-sm">
                            <thead class="bg-gray-50 text-gray-500 uppercase font-bold border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-3">Organization</th>
                                    <th class="px-6 py-3">Representative</th>
                                    <th class="px-6 py-3">Approved Date</th>
                                    <th class="px-6 py-3 text-right">Contract Action</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for partner in active_partners %}
                                <tr class="hover:bg-gray-50 transition">
                                    <td class="px-6 py-4 font-bold text-gray-900">{{ partner.org_name }}</td>
                                    <td class="px-6 py-4 text-gray-600">{{ partner.user.first_name }} {{ partner.user.last_name }}</td>
                                    <td class="px-6 py-4 text-gray-500">{{ partner.created_at.strftime('%b %d, %Y') }}</td>
                                    <td class="px-6 py-4 text-right">
                                        <a href="{{ url_for('admin.end_partner_contract', id=partner.id) }}" 
                                           class="bg-gray-100 text-gray-600 hover:bg-red-100 hover:text-red-600 px-4 py-2 rounded text-xs font-bold transition border border-gray-200 hover:border-red-200"
                                           onclick="return confirm('End contract with {{ partner.org_name }}? They will be moved to archives.')">
                                            <i class="fa-solid fa-ban"></i> End Contract
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="px-6 py-4 text-center text-gray-400">No active partners found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                            <h3 class="font-bold text-gray-900">Recent Mentorship Applications </h3>
                        </div>
                        <table class="min-w-full text-left text-sm">
                            <tbody class="divide-y divide-gray-200">
                                {% for mentor in recent_mentors %}
                                <tr>
                                    <td class="px-6 py-3">
                                        <div class="font-medium text-gray-900">
                                            {{ mentor.child_first_name if mentor.child_first_name else mentor.user.first_name }}
                                        </div>
                                        <div class="text-xs text-gray-500">{{ mentor.program_track }}</div>
                                    </td>
                                    <td class="px-6 py-3 text-right text-xs text-gray-400">
                                        {{ mentor.created_at.strftime('%b %d') }}
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td class="px-6 py-4 text-center text-gray-400 text-xs">No recent applications.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                            <h3 class="font-bold text-gray-900">Recently Approved Partners</h3>
                        </div>
                        <table class="min-w-full text-left text-sm">
                            <tbody class="divide-y divide-gray-200">
                                {% for partner in recent_approved %}
                                <tr>
                                    <td class="px-6 py-3">
                                        <div class="font-medium text-green-700">{{ partner.org_name }}</div>
                                        <div class="text-xs text-gray-500">{{ partner.partnership_type }}</div>
                                    </td>
                                    <td class="px-6 py-3 text-right text-xs text-gray-400">
                                        {{ partner.created_at.strftime('%b %d') }}
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td class="px-6 py-4 text-center text-gray-400 text-xs">No approved partners yet.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>

            </div>
        </main>
    </div>
</body>
</html>